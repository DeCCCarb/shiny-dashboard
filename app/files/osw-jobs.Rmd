---
title: "Floating Offshore Wind Job Impacts"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
mainfont: "Avenir"
fontsize: 11pt
geometry: margin=1in
---

```{r logo, out.width="3in", echo=FALSE}
knitr::include_graphics(here("app", "www", "the2035initiative-logo.png"))
knitr::include_graphics(here("app", "www", "communitylabor-logo.png"))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(glue)
library(usdata)
library(tmap)
library(tigris)
library(ggplot2)

first_year <-input$year_range_input_roof[1]
final_year <-input$year_range_input_roof[2]
final_cap <- input$final_capacity_input


# Calculate annual jobs when port is in CC
if (!("No Central Coast Port" %in% input$osw_port_input)) {
    # OSW O&M jobs
    osw_om <- calculate_osw_om_jobs(
        county = "Tri-county",
        start_year = input$year_range_input[1],
        end_year = input$year_range_input[2],
        ambition = "High",
        initial_capacity = input$initial_capacity_input,
        target_capacity = input$final_capacity_input,
        direct_jobs = 127,
        indirect_jobs = 126,
        induced_jobs = 131
    )
    
    # OSW Construction
    osw_construction <- calculate_osw_construction_jobs(
        county = "Tri-County",
        start_year = input$year_range_input[1],
        end_year = input$year_range_input[2],
        ambition = "High",
        initial_capacity = input$initial_capacity_input,
        target_capacity = input$final_capacity_input,
        direct_jobs = 82,
        indirect_jobs = 2571,
        induced_jobs = 781
    )
    
    # Bind together
    osw_all <- rbind(osw_om, osw_construction) |>
        filter(type == input$job_type_input)
    
    # Calculate annual jobs when port is NOT in CC
} else {
    # Return 0 jobs
    osw_all <- data.frame(
        year = integer(),
        n_jobs = numeric(),
        occupation = character(),
        type = character(),
        stringsAsFactors = FALSE
    )
}

# Calculate total construction jobs
const_njobs_label <- osw_all |>
    filter(occupation == "Construction")

const_njobs_label <- round(sum(const_njobs_label$n_jobs, na.rm = TRUE), 0)

# Calculate total O&M jobs
om_njobs_label <- osw_all |>
    filter(occupation == "O&M")

om_njobs_label <- round(sum(om_njobs_label$n_jobs, na.rm = TRUE), 0)

# Generate and format label
osw_map_label <- paste(
        "Total Jobs in Central Coast", 
        "\n- Construction:",
        scales::comma(const_njobs_label), 
        "\n- O&M:",
        scales::comma(om_njobs_label)
    )

```

## For the duration of all projects needed to meet your capacity goal of (`r final_cap` GW) for Floating Offshore Wind by `r final_year`, there would be `r scales::comma(const_njobs_label)` construction jobs and `r scales::comma(om_njobs_label)` operations & maintenance jobs created. 






```{r, fig.show='hold', fig.width = 6, fig.height = 4, warning=FALSE, message=FALSE, quiet=TRUE}
# O&M OSW ---
        osw <- calculate_osw_om_jobs(
            county = "Tri-county",
            start_year = input$year_range_input[1],
            end_year = input$year_range_input[2],
            ambition = "High",
            initial_capacity = input$initial_capacity_input,
            target_capacity = input$final_capacity_input,
            direct_jobs = 127,
            indirect_jobs = 126,
            induced_jobs = 131
        )
        
        ######## Generate Plot for OSW ##############
        
        osw_cap_plot <- ggplot() +
            geom_point(data = osw, 
                       aes(x = as.factor(year), y = total_capacity_gw),
                       color = "#A3BDBE") +
            geom_point(data = osw,
                       aes(x = as.factor(year), y = new_capacity_gw),
                       color = "#3A8398") +
            scale_x_discrete(breaks = scales::breaks_pretty(n=4)) +
            labs(y = "Capacity (GW)",
                 title = "Capacity Growth Rate to Meet Target ") +
            theme_minimal() +
            theme(
                axis.title.x = element_blank(),
            )
osw_cap_plot

```

```{r stacked-plots, fig.show='hold', fig.height=4, fig.width=6, warning=FALSE, message=FALSE}
# First plot
# print(ccc)
# cat("\n\n")
# # Second plot
# print(osw_cap_plot)

```


```{r, fig.show='hold', fig.width = 6, fig.height = 4,warning=FALSE, message=FALSE, quiet=TRUE}
# Floating Offshore Wind ------
        if ("No Central Coast Port" %in% input$osw_port_input) {
            # Generate a dummy df to preserve x and y axis
            years <- input$year_range_input[1]:input$year_range_input[2]
            dummy_df <- data.frame(
                year = years,
                n_jobs = rep(0, length(years)),
                occupation = factor(rep(NA, length(years))),
                type = rep(NA, length(years))
            )
            # #         # Plot showing no jobs
            empty_plot <- ggplot(dummy_df, aes(x = as.factor(year), y = n_jobs)) +
                geom_col(fill = "#cccccc") +
                scale_y_continuous(limits = c(0, 2000),
                                   labels = scales::comma) +
                scale_x_discrete(breaks = scales::breaks_pretty(n = 5)) +
                labs(title = "Projected jobs in CA Central Coast \nfrom Floating OSW development", y = "FTE Jobs") +
                annotate(
                    "text",
                    x = as.factor(median(years)),
                    y = 1000,
                    label = "No Port in Central Coast â€” job projections are 0",
                    size = 5,
                    color = "gray30"
                ) +
                theme_minimal() +
                theme(
                    axis.title.x = element_blank(),
                    axis.title.y = element_text(margin = margin(10, 10, 10, 10)),
                    legend.position = "none"
                )
            
            empty_plot
        }else{
        
        osw_om <- calculate_osw_om_jobs(
            county = "Tri-county",
            start_year = input$year_range_input[1],
            end_year = input$year_range_input[2],
            ambition = "High",
            initial_capacity = input$initial_capacity_input,
            target_capacity = input$final_capacity_input,
            direct_jobs = 127,
            indirect_jobs = 126,
            induced_jobs = 131
        )
        
        # Construction OSW --
        osw_construction <- calculate_osw_construction_jobs(
            county = "Tri-County",
            start_year = input$year_range_input[1],
            end_year = input$year_range_input[2],
            ambition = "High",
            initial_capacity = input$initial_capacity_input,
            target_capacity = input$final_capacity_input,
            direct_jobs = 82,
            indirect_jobs = 2571,
            induced_jobs = 781
        )
        
        
        # Create joined dataframe
        osw_all <- rbind(osw_construction, osw_om) |>
            filter(type %in% input$job_type_input) # Filter to inputted job type
        
        ######## Generate Plot for OSW ##############
        osw_plot <- ggplot(osw_all,
                           aes(
                               x = as.factor(year),
                               y = round(n_jobs, 0),
                               group = occupation
                           )) +
            geom_col(aes(fill = occupation, text = purrr::map(
                paste0(occupation, " jobs: ", scales::comma(round(n_jobs, 0))), HTML
            ))) +
            scale_fill_manual(
                labels = c("Construction Jobs", "Operations & Maintenance Jobs"),
                values = c("#3A8398", "#A3BDBE")
            ) +
            scale_y_continuous(limits = c(0, 2000), labels = scales::comma) +
            scale_x_discrete(breaks = scales::breaks_pretty(n = 5)) +
            labs(
                title = glue::glue(
                    "Projected {input$job_type_input} jobs in CA Central Coast from Floating OSW development"
                ),
                y = "FTE Jobs"
            ) +
            theme_minimal() +
            theme(
                # Axes
                axis.title.x = element_blank(),
                axis.title.y = element_text(margin = margin(10, 10, 10, 10)),
                
                # Legend
                legend.title = element_blank(),
                legend.position = "bottom"
                
            )
        
        osw_plot
    }

```

